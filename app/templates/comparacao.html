<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparação de Imóveis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <div class="container-fluid py-4 px-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-diagram-3"></i> Comparação de Imóveis</h1>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
                <a href="/imoveis_baratos" class="btn btn-outline-secondary">
                    <i class="bi bi-gem"></i> Oportunidades
                </a>
            </div>
        </div>

        <div class="filter-section">
            <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros de Comparação</h5>
            <div class="row g-3">
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Estado</label>
                    <select id="uf-filter" class="form-select">
                        <option value="">Todos os Estados</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Cidade</label>
                    <select id="cidade-filter" class="form-select">
                        <option value="">Todas as Cidades</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Bairro</label>
                    <select id="bairro-filter" class="form-select">
                        <option value="">Todos os Bairros</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Tipologia</label>
                    <select id="tipo-filter" class="form-select">
                        <option value="">Todas as Tipologias</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Modalidade</label>
                    <select id="modalidade-filter" class="form-select">
                        <option value="">Todas as Modalidades</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Status</label>
                    <select id="status-filter" class="form-select">
                        <option value="Ativos" selected>Ativos</option>
                        <option value="Apenas Novos">Apenas Novos</option>
                        <option value="Expirado">Expirado</option>
                        <option value="Todos">Todos</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Preço Mínimo</label>
                    <input type="number" id="preco-min-filter" class="form-control" placeholder="R$ 0">
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label class="form-label">Preço Máximo</label>
                    <input type="number" id="preco-max-filter" class="form-control" placeholder="R$ 1.000.000">
                </div>
                <div class="col-lg-4 col-md-6 col-sm-12 d-flex align-items-end">
                    <div class="filter-actions w-100">
                        <button id="apply-filters" class="btn btn-primary flex-fill">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <button id="clear-filters" class="btn btn-warning flex-fill">
                            <i class="bi bi-arrow-clockwise"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="comparison-results">
            <div class="loading-message">
                <i class="bi bi-arrow-repeat"></i>
                <h3>Carregando dados de comparação...</h3>
                <p>Aguarde enquanto organizamos os imóveis por localização.</p>
            </div>
        </div>
    </div>

    {% include '_progress_bar.html' %}

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        $(document).ready(function() {
            let allData = [];
            let filterableLocations = {};
            
            const formatCurrency = (value) => {
                if (!value || value === 0 || value === '0.00') return 'R$ 0,00';
                const num = parseFloat(value);
                if (isNaN(num)) return 'R$ 0,00';
                return `R$ ${num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatArea = (value) => {
                if (!value || value === 'N/A' || value === 'null' || value === null) return 'N/A';
                if (typeof value === 'string' && value.includes('m²')) return value;
                const num = parseFloat(value);
                if (isNaN(num)) return 'N/A';
                return `${num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} m²`;
            };

            const calculatePricePerM2 = (preco, areaPrivativa, areaTerreno) => {
                const price = parseFloat(preco);
                if (isNaN(price) || price <= 0) return 'N/A';

                let area = 0;
                
                if (areaPrivativa && areaPrivativa !== 'N/A' && areaPrivativa !== 'null' && areaPrivativa !== null) {
                    const areaPrivNum = parseFloat(areaPrivativa.toString().replace(/[^\d.,]/g, '').replace(',', '.'));
                    if (!isNaN(areaPrivNum) && areaPrivNum > 0) {
                        area = areaPrivNum;
                    }
                }

                if (area === 0 && areaTerreno && areaTerreno !== 'N/A' && areaTerreno !== 'null' && areaTerreno !== null) {
                    const areaTerNum = parseFloat(areaTerreno.toString().replace(/[^\d.,]/g, '').replace(',', '.'));
                    if (!isNaN(areaTerNum) && areaTerNum > 0) {
                        area = areaTerNum;
                    }
                }

                if (area <= 0) return 'N/A';

                const pricePerM2 = price / area;
                return `R$ ${pricePerM2.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatStatus = (status) => {
                if (!status) status = 'Existente';
                const statusClass = status.toLowerCase().replace(/\s+/g, '');
                return `<span class="badge status-${statusClass}">${status}</span>`;
            };

            // Função para aplicar destaque granular - IGUAL AO DASHBOARD
            const applyFieldHighlight = (row, data) => {
                if (data.Status === 'Atualizado' && data.ChangedFields) {
                    const changedFields = data.ChangedFields.split(',');
                    const columnsMap = {
                        'ENDERECO': 0,
                        'PRECO': 1,
                        'AVALIACAO': 2,
                        'DESCONTO': 3,
                        'AREA_PRIVATIVA': 4,
                        'AREA_DO_TERRENO': 5,
                        'MODALIDADE': 7,
                        'Status': 8,
                        'TIPO': 9
                    };

                    changedFields.forEach(fieldName => {
                        const trimmedField = fieldName.trim();
                        if (columnsMap.hasOwnProperty(trimmedField)) {
                            const colIndex = columnsMap[trimmedField];
                            $(row).find('td').eq(colIndex).addClass('cell-updated');
                        }
                    });
                }
            };

            const groupData = (data) => {
                const grouped = {};
                
                data.forEach(imovel => {
                    const uf = imovel.UF || 'N/A';
                    const cidade = imovel.CIDADE || 'N/A';
                    const bairro = imovel.BAIRRO || 'N/A';
                    
                    if (!grouped[uf]) grouped[uf] = {};
                    if (!grouped[uf][cidade]) grouped[uf][cidade] = {};
                    if (!grouped[uf][cidade][bairro]) grouped[uf][cidade][bairro] = [];
                    
                    grouped[uf][cidade][bairro].push(imovel);
                });
                
                // Filtrar apenas bairros com 2 ou mais imóveis
                Object.keys(grouped).forEach(uf => {
                    Object.keys(grouped[uf]).forEach(cidade => {
                        Object.keys(grouped[uf][cidade]).forEach(bairro => {
                            if (grouped[uf][cidade][bairro].length < 2) {
                                delete grouped[uf][cidade][bairro];
                            }
                        });
                        // Remove cidades sem bairros comparáveis
                        if (Object.keys(grouped[uf][cidade]).length === 0) {
                            delete grouped[uf][cidade];
                        }
                    });
                    // Remove UFs sem cidades comparáveis
                    if (Object.keys(grouped[uf]).length === 0) {
                        delete grouped[uf];
                    }
                });
                
                return grouped;
            };

            const renderData = (grouped) => {
                if (Object.keys(grouped).length === 0) {
                    return `
                        <div class="no-data-message">
                            <i class="bi bi-search"></i>
                            <h3>Nenhum resultado encontrado</h3>
                            <p>Tente ajustar os filtros para encontrar imóveis que atendam aos critérios.</p>
                        </div>
                    `;
                }

                let html = '';
                
                Object.keys(grouped).forEach(uf => {
                    html += `<div class="mb-5">
                        <h2 class="uf-header">${uf}</h2>`;
                    
                    Object.keys(grouped[uf]).forEach(cidade => {
                        const bairros = grouped[uf][cidade];
                        
                        const bairrosComparaveis = Object.keys(bairros);
                        
                        if (bairrosComparaveis.length > 0) {
                            const cidadeTotal = bairrosComparaveis.reduce((sum, bairro) => sum + bairros[bairro].length, 0);
                            const precos = bairrosComparaveis.flatMap(bairro => bairros[bairro])
                                .map(i => parseFloat(i.PRECO))
                                .filter(p => !isNaN(p) && p > 0);
                            const precoMedio = precos.length > 0 ? precos.reduce((a, b) => a + b, 0) / precos.length : 0;
                            
                            html += `<div class="group-container">
                                <h3 class="cidade-header">
                                    <i class="bi bi-geo-alt"></i> ${cidade}
                                </h3>
                                <div class="stats-row">
                                    <div class="stat-item">
                                        <div class="stat-value">${cidadeTotal}</div>
                                        <div class="stat-label">Imóveis Comparáveis</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${bairrosComparaveis.length}</div>
                                        <div class="stat-label">Bairros c/ Múltiplos</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${formatCurrency(precoMedio)}</div>
                                        <div class="stat-label">Preço Médio</div>
                                    </div>
                                </div>`;
                            
                            bairrosComparaveis.forEach(bairro => {
                                const imoveis = bairros[bairro];
                                
                                imoveis.sort((a, b) => {
                                    const enderecoA = (a.ENDERECO || 'N/A').toLowerCase();
                                    const enderecoB = (b.ENDERECO || 'N/A').toLowerCase();
                                    return enderecoA.localeCompare(enderecoB);
                                });
                                
                                html += `<div class="card mb-4">
                                    <div class="card-header">
                                        <h4 class="bairro-header mb-0">
                                            <span><i class="bi bi-buildings"></i> Bairro: ${bairro}</span>
                                            <span class="property-count">${imoveis.length} Imóveis</span>
                                        </h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover comparison-table" data-bairro="${bairro}">
                                                <thead>
                                                    <tr>
                                                        <th><i class="bi bi-house"></i> Endereço</th>
                                                        <th><i class="bi bi-currency-dollar"></i> Preço</th>
                                                        <th><i class="bi bi-calculator"></i> Avaliação</th>
                                                        <th><i class="bi bi-percent"></i> Desconto</th>
                                                        <th><i class="bi bi-rulers"></i> Área Privativa</th>
                                                        <th><i class="bi bi-map"></i> Área Terreno</th>
                                                        <th><i class="bi bi-calculator-fill"></i> R$/m²</th>
                                                        <th><i class="bi bi-tag"></i> Modalidade</th>
                                                        <th><i class="bi bi-bookmark"></i> Status</th>
                                                        <th><i class="bi bi-building"></i> Tipologia</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
                                
                                // Armazenar dados para aplicar destaque depois
                                window.comparisonData = window.comparisonData || {};
                                window.comparisonData[bairro] = imoveis;
                                
                                imoveis.forEach((imovel, index) => {
                                    const precoM2 = calculatePricePerM2(imovel.PRECO, imovel.AREA_PRIVATIVA, imovel.AREA_DO_TERRENO);
                                    
                                    html += `<tr data-link="${imovel.LINK}" data-bairro="${bairro}" data-index="${index}" class="property-row" style="cursor: pointer;">
                                        <td>${imovel.ENDERECO || 'N/A'}</td>
                                        <td class="price-column">${formatCurrency(imovel.PRECO)}</td>
                                        <td class="price-column">${formatCurrency(imovel.AVALIACAO)}</td>
                                        <td class="discount-column">${imovel.DESCONTO || '0%'}</td>
                                        <td class="area-column">${formatArea(imovel.AREA_PRIVATIVA)}</td>
                                        <td class="area-column">${formatArea(imovel.AREA_DO_TERRENO)}</td>
                                        <td class="preco-m2-column">${precoM2}</td>
                                        <td>${imovel.MODALIDADE || 'N/A'}</td>
                                        <td>${formatStatus(imovel.Status)}</td>
                                        <td class="tipo-column">${imovel.TIPO || 'N/A'}</td>
                                    </tr>`;
                                });
                                
                                html += `</tbody></table></div></div></div>`;
                            });
                            
                            html += `</div>`;
                        }
                    });
                    
                    html += `</div>`;
                });

                return html;
            };

            const loadInitialData = () => {
                $.get('/api/data', { status: 'Ativos' })
                    .done(function(data) {
                        allData = data;
                        if (data.length === 0) {
                            $('#comparison-results').html(`
                                <div class="no-data-message">
                                    <i class="bi bi-house-x"></i>
                                    <h3>Nenhum imóvel para comparação encontrado</h3>
                                    <p>Inicie uma raspagem no Dashboard para popular os dados ou ajuste os filtros acima.</p>
                                    <a href="/" class="btn btn-primary mt-3">
                                        <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
                                    </a>
                                </div>
                            `);
                        } else {
                            const grouped = groupData(data);
                            const html = renderData(grouped);
                            $('#comparison-results').html(html);
                            
                            // APLICAR DESTAQUE GRANULAR - usando dados armazenados
                            setTimeout(() => {
                                $('.property-row').each(function() {
                                    const bairro = $(this).data('bairro');
                                    const index = $(this).data('index');
                                    
                                    if (window.comparisonData && window.comparisonData[bairro] && window.comparisonData[bairro][index]) {
                                        const imovelData = window.comparisonData[bairro][index];
                                        applyFieldHighlight(this, imovelData);
                                    }
                                });
                            }, 100);

                            $('.property-row').on('click', function() {
                                const link = $(this).data('link');
                                if (link) {
                                    window.open(link, '_blank');
                                }
                            });
                        }
                    })
                    .fail(function() {
                        $('#comparison-results').html(`
                            <div class="no-data-message">
                                <i class="bi bi-exclamation-triangle"></i>
                                <h3>Erro ao carregar dados</h3>
                                <p>Não foi possível carregar os dados dos imóveis. Verifique a conexão.</p>
                            </div>
                        `);
                    });
            };

            // Carregar filtros específicos para comparação
            const loadComparableFilters = () => {
                // Carregar UFs que têm bairros comparáveis
                $.get('/api/comparacao/ufs', function(data) {
                    const ufSelect = $('#uf-filter');
                    ufSelect.html('<option value="">Todos os Estados</option>');
                    (data || []).forEach(uf => {
                        ufSelect.append(`<option value="${uf}">${uf}</option>`);
                    });
                });

                // Carregar tipos e modalidades
                $.get('/api/filters', function(data) {
                    const tipoSelect = $('#tipo-filter');
                    tipoSelect.html('<option value="">Todas as Tipologias</option>');
                    (data.tipos || []).forEach(tipo => {
                        tipoSelect.append(`<option value="${tipo}">${tipo}</option>`);
                    });

                    const modalidadeSelect = $('#modalidade-filter');
                    modalidadeSelect.html('<option value="">Todas as Modalidades</option>');
                    (data.modalidades || []).forEach(modalidade => {
                        modalidadeSelect.append(`<option value="${modalidade}">${modalidade}</option>`);
                    });
                });
            };

            // Filtro cascata - UF -> Cidade
            $('#uf-filter').on('change', function() {
                const selectedUf = $(this).val();
                $('#cidade-filter').html('<option value="">Todas as Cidades</option>');
                $('#bairro-filter').html('<option value="">Todos os Bairros</option>');
                
                if (selectedUf) {
                    $.get('/api/comparacao/cidades', { uf: selectedUf }, function(cidades) {
                        cidades.forEach(cidade => {
                            $('#cidade-filter').append(`<option value="${cidade}">${cidade}</option>`);
                        });
                    });
                }
            });

            // Filtro cascata - Cidade -> Bairro
            $('#cidade-filter').on('change', function() {
                const selectedCidade = $(this).val();
                const selectedUf = $('#uf-filter').val();
                $('#bairro-filter').html('<option value="">Todos os Bairros</option>');
                
                if (selectedCidade && selectedUf) {
                    $.get('/api/comparacao/bairros', { uf: selectedUf, cidade: selectedCidade }, function(bairros) {
                        bairros.forEach(bairro => {
                            $('#bairro-filter').append(`<option value="${bairro}">${bairro}</option>`);
                        });
                    });
                }
            });

            $('#clear-filters').on('click', function() {
                $('#uf-filter').val('');
                $('#cidade-filter').html('<option value="">Todas as Cidades</option>');
                $('#bairro-filter').html('<option value="">Todos os Bairros</option>');
                $('#tipo-filter').val('');
                $('#modalidade-filter').val('');
                $('#status-filter').val('Ativos');
                $('#preco-min-filter').val('');
                $('#preco-max-filter').val('');
                
                loadInitialData();
            });

            $('#apply-filters').on('click', function() {
                const filters = {
                    uf: $('#uf-filter').val(),
                    cidade: $('#cidade-filter').val(),
                    bairro: $('#bairro-filter').val(),
                    tipo: $('#tipo-filter').val(),
                    modalidade: $('#modalidade-filter').val(),
                    status: $('#status-filter').val(),
                    preco_min: $('#preco-min-filter').val(),
                    preco_max: $('#preco-max-filter').val()
                };

                $('#comparison-results').html(`
                    <div class="loading-message">
                        <i class="bi bi-arrow-repeat"></i>
                        <h3>Aplicando filtros...</h3>
                        <p>Organizando resultados por localização.</p>
                    </div>
                `);

                $.get('/api/data', filters)
                    .done(function(data) {
                        const grouped = groupData(data);
                        const html = renderData(grouped);
                        $('#comparison-results').html(html);
                        
                        // APLICAR DESTAQUE GRANULAR após filtros
                        setTimeout(() => {
                            $('.property-row').each(function() {
                                const bairro = $(this).data('bairro');
                                const index = $(this).data('index');
                                
                                if (window.comparisonData && window.comparisonData[bairro] && window.comparisonData[bairro][index]) {
                                    const imovelData = window.comparisonData[bairro][index];
                                    applyFieldHighlight(this, imovelData);
                                }
                            });
                        }, 100);
                        
                        $('.property-row').on('click', function() {
                            const link = $(this).data('link');
                            if (link) {
                                window.open(link, '_blank');
                            }
                        });
                    })
                    .fail(function() {
                        $('#comparison-results').html(`
                            <div class="no-data-message">
                                <i class="bi bi-exclamation-triangle"></i>
                                <h3>Erro ao aplicar filtros</h3>
                                <p>Não foi possível filtrar os dados. Tente novamente.</p>
                            </div>
                        `);
                    });
            });

            loadComparableFilters();
            loadInitialData();
        });
    </script>
</body>
</html>